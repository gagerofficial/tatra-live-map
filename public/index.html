<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project GOB | Integrated Network Dispatch</title>
    <style>
        :root {
            --gob-yellow: #ffcc00;
            --gob-dark: #121212;
            --gob-panel: rgba(30, 30, 30, 0.95);
            --br-white: #ffffff;
            --track-color: #333;
        }

        body { 
            margin: 0; background: var(--gob-dark); color: white; 
            font-family: 'Gill Sans', 'Gill Sans MT', 'Trebuchet MS', sans-serif; 
            overflow: hidden; 
        }

        /* --- NAVIGÁCIÓ (BR STÍLUS) --- */
        nav {
            height: 65px; background: var(--br-white); color: black;
            display: flex; align-items: center; padding: 0 30px;
            border-bottom: 6px solid var(--gob-yellow);
            box-shadow: 0 4px 20px rgba(0,0,0,0.6); z-index: 1000; position: relative;
        }

        .logo-text { font-weight: 900; font-size: 26px; letter-spacing: -1px; }
        .sub-text { 
            margin-left: 15px; font-weight: 400; border-left: 2px solid #ddd; 
            padding-left: 15px; text-transform: uppercase; font-size: 14px; color: #444;
        }

        /* --- TÉRKÉP --- */
        #map-container {
            width: 100vw; height: calc(100vh - 71px);
            position: relative; overflow: hidden; background: #181818;
        }

        #map { 
            width: 5000px; height: 5000px; position: absolute; 
            background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            transition: transform 0.1s ease-out;
        }

        /* --- JÁRMŰ ÉS MEGÁLLÓ --- */
        .tram { 
            position: absolute; width: 16px; height: 40px; 
            background: var(--gob-yellow); border: 2px solid black;
            cursor: pointer; z-index: 100; border-radius: 2px;
            transition: left 0.9s linear, top 0.9s linear, transform 0.9s linear;
        }
        .tram.selected { box-shadow: 0 0 0 3px white, 0 0 20px var(--gob-yellow); }

        .stop-dot {
            position: absolute; width: 10px; height: 10px;
            background: #fff; border: 2px solid #000; border-radius: 50%;
            z-index: 50; transform: translate(-50%, -50%);
        }
        .stop-label {
            position: absolute; font-size: 10px; color: #888;
            transform: translate(12px, -5px); white-space: nowrap; pointer-events: none;
        }

        svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        line { stroke: var(--track-color); stroke-width: 3; stroke-linecap: round; }

        /* --- OLDALSÁV --- */
        #sidebar { 
            position: absolute; top: 20px; left: 20px; bottom: 20px;
            width: 340px; background: var(--gob-panel);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 4px;
            display: flex; flex-direction: column; backdrop-filter: blur(10px);
            z-index: 500;
        }

        .panel-header { background: #252525; color: var(--gob-yellow); padding: 12px 15px; font-weight: bold; font-size: 13px; letter-spacing: 1px; }
        .stats { padding: 20px; flex-grow: 1; }
        .data-card { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 4px; margin-bottom: 10px; }
        .label { font-size: 10px; color: #aaa; text-transform: uppercase; display: block; }
        .value { font-size: 20px; font-weight: bold; color: white; }

        .status-pill {
            display: inline-block; padding: 4px 10px; border-radius: 2px;
            font-size: 12px; font-weight: bold; margin-top: 10px;
        }

        #fleet-list { height: 180px; overflow-y: auto; background: rgba(0,0,0,0.4); }
        .fleet-item { 
            padding: 10px 15px; border-bottom: 1px solid #333; cursor: pointer; 
            display: flex; justify-content: space-between; font-size: 14px;
        }
        .fleet-item:hover { background: rgba(255,204,0,0.1); }
    </style>
</head>
<body>

<nav>
    <div class="logo-text">PROJECT GOB</div>
    <div class="sub-text">Budapest Network Control | Strategic Operations</div>
</nav>

<div id="map-container">
    <div id="map">
        <svg id="tracks-layer"></svg>
    </div>
</div>

<div id="sidebar">
    <div class="panel-header">TELEMETRY DATA</div>
    <div class="stats" id="stats-panel">
        <div style="text-align: center; padding-top: 50px; color: #555;">
            SELECT VEHICLE FOR LIVE DATA
        </div>
    </div>
    
    <div class="panel-header">ACTIVE NETWORK UNITS</div>
    <div id="fleet-list"></div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
    const socket = io();
    const map = document.getElementById('map');
    const svgLayer = document.getElementById('tracks-layer');
    const vehicles = {};
    let selectedId = null;

    // --- MEGÁLLÓK ÉS PÁLYA ADATOK ---
    // Ide írd majd be a valódi koordinátáidat!
    const stopsData = {
        "1": [
            { name: "teststop1", x: 1113, z: -993 },
            { name: "teststop2", x: 1123, z: -1310 },
            { name: "teststop3", x: 1143, z: -1868 }
        ]
    };

    const scale = 0.08;
    const cX = 2500; // Térkép közepe (5000/2)
    const cY = 2500;

    // Megállók és vágányok inicializálása
    function initNetwork() {
        Object.keys(stopsData).forEach(lineId => {
            const stops = stopsData[lineId];
            for (let i = 0; i < stops.length; i++) {
                // Pötty létrehozása
                const s = stops[i];
                const dot = document.createElement('div');
                dot.className = 'stop-dot';
                dot.style.left = (cX + s.x * scale) + 'px';
                dot.style.top = (cY + s.z * scale) + 'px';
                dot.innerHTML = `<div class="stop-label">${s.name}</div>`;
                map.appendChild(dot);

                // Vonal húzása a következő megállóig
                if (stops[i+1]) {
                    const s2 = stops[i+1];
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute("x1", cX + s.x * scale);
                    line.setAttribute("y1", cY + s.z * scale);
                    line.setAttribute("x2", cX + s2.x * scale);
                    line.setAttribute("y2", cY + s2.z * scale);
                    svgLayer.appendChild(line);
                }
            }
        });
    }

    // --- SOCKET KOMMUNIKÁCIÓ ---
    socket.on('tramUpdate', (data) => {
        if (!vehicles[data.id]) {
            const el = document.createElement('div');
            el.className = 'tram';
            el.onclick = () => selectVehicle(data.id);
            map.appendChild(el);
            vehicles[data.id] = { el: el };
        }

        const v = vehicles[data.id];
        v.data = data;

        v.el.style.left = (cX + data.x * scale) + 'px';
        v.el.style.top = (cY + data.z * scale) + 'px';
        v.el.style.transform = `translate(-50%, -50%) rotate(${data.heading}deg)`;

        if (selectedId === data.id) {
            updateStats();
            // Kamera követés (opcionális: ha akarod, hogy a térkép mozogjon a kijelölt után)
            const mapC = document.getElementById('map-container');
            map.style.transform = `translate(${- (cX + data.x * scale) + mapC.offsetWidth/2}px, ${- (cY + data.z * scale) + mapC.offsetHeight/2}px)`;
        }
        updateFleetList();
    });

    function selectVehicle(id) {
        if (selectedId && vehicles[selectedId]) vehicles[selectedId].el.classList.remove('selected');
        selectedId = id;
        vehicles[id].el.classList.add('selected');
        updateStats();
    }

    function updateStats() {
        const d = vehicles[selectedId].data;
        const delayStatus = d.delay > 30 ? 
            { t: `DELAY: ${Math.floor(d.delay/60)}m ${d.delay%60}s`, c: '#ff4444' } : 
            { t: "ON TIME", c: "#00ff00" };

        document.getElementById('stats-panel').innerHTML = `
            <div class="data-card"><span class="label">Callsign</span><span class="value">LINE ${d.line}</span></div>
            <div class="data-card"><span class="label">Operator</span><span class="value">${d.driver}</span></div>
            <div class="data-card"><span class="label">Velocity</span><span class="value">${d.speed} KM/H</span></div>
            <div class="data-card"><span class="label">Next Terminal</span><span class="value">${d.nextStop}</span></div>
            <div class="status-pill" style="background: ${delayStatus.c}22; color: ${delayStatus.c}">${delayStatus.t}</div>
        `;
    }

    function updateFleetList() {
        const list = document.getElementById('fleet-list');
        list.innerHTML = "";
        Object.keys(vehicles).forEach(id => {
            const d = vehicles[id].data;
            const item = document.createElement('div');
            item.className = 'fleet-item';
            item.style.borderLeft = (id === selectedId) ? "4px solid var(--gob-yellow)" : "none";
            item.innerHTML = `<span>Line ${d.line}</span><span>${d.driver}</span>`;
            item.onclick = () => selectVehicle(id);
            list.appendChild(item);
        });
    }

    initNetwork();
</script>

</body>
</html>

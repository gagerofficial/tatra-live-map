<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Project GOB | Integrated Transit Control</title>
    <style>
        :root {
            --gob-yellow: #ffcc00;
            --gob-dark: #121212;
            --gob-panel: #1e1e1e;
            --br-blue: #003399; /* British Rail Blue kiegészítésnek */
        }

        body { 
            margin: 0; background: var(--gob-dark); color: white; 
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, sans-serif; 
            overflow: hidden; 
        }

        /* Felső Navigáció - British Rail stílus */
        nav {
            height: 60px; background: white; color: black;
            display: flex; align-items: center; padding: 0 30px;
            border-bottom: 5px solid var(--gob-yellow);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 1000; position: relative;
        }

        .logo-text { font-weight: 900; font-size: 24px; letter-spacing: -1px; }
        .sub-text { margin-left: 15px; font-weight: 300; border-left: 1px solid #ccc; padding-left: 15px; text-transform: uppercase; font-size: 14px; }

        #map { 
            width: 100vw; height: calc(100vh - 65px); position: relative; 
            background: #1a1a1a;
            background-image: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* Jármű ikonok */
        .tram { 
            position: absolute; width: 15px; height: 35px; 
            background: var(--gob-yellow); border: 2px solid black;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            z-index: 10;
        }
        .tram.selected { box-shadow: 0 0 0 3px white, 0 0 15px var(--gob-yellow); z-index: 100; }

        /* Oldalsáv - "Glass" effekt */
        #sidebar { 
            position: absolute; top: 80px; left: 20px; bottom: 20px;
            width: 320px; background: rgba(30, 30, 30, 0.9);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 4px;
            display: flex; flex-direction: column; backdrop-filter: blur(10px);
        }

        .panel-header { background: var(--gob-yellow); color: black; padding: 10px 15px; font-weight: bold; font-size: 14px; }
        .stats { padding: 20px; flex-grow: 1; }
        .data-row { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .label { font-size: 11px; color: #888; text-transform: uppercase; }
        .value { font-size: 18px; font-weight: bold; display: block; }

        .delay-box { padding: 5px 10px; border-radius: 2px; font-weight: bold; margin-top: 5px; display: inline-block; }
        
        #fleet-list { height: 200px; border-top: 1px solid #444; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); }
        .fleet-item { padding: 8px; border-bottom: 1px solid #333; cursor: pointer; font-size: 13px; }
        .fleet-item:hover { background: rgba(255,255,255,0.05); }
    </style>
</head>
<body>

<nav>
    <div class="logo-text">PROJECT GOB</div>
    <div class="sub-text">Integrated Network Dispatch | Budapest</div>
</nav>

<div id="map"></div>

<div id="sidebar">
    <div class="panel-header">VEHICLE TELEMETRY</div>
    <div class="stats" id="stats-panel">
        <p style="color: #666;">Válassz egy járművet a térképen vagy a listából.</p>
    </div>
    <div class="panel-header" style="background: #333; color: white;">ACTIVE FLEET</div>
    <div id="fleet-list"></div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
    const socket = io();
    const vehicles = {};
    let selectedId = null;

    socket.on('tramUpdate', (data) => {
        // Frissítés vagy létrehozás
        if (!vehicles[data.id]) {
            const el = document.createElement('div');
            el.className = 'tram';
            el.onclick = () => selectVehicle(data.id);
            document.getElementById('map').appendChild(el);
            vehicles[data.id] = { el: el };
        }

        const v = vehicles[data.id];
        v.data = data;

        // Pozíció (Állítsd be a scale-t a mapodhoz!)
        const scale = 0.08;
        const cX = window.innerWidth / 2;
        const cY = window.innerHeight / 2;
        
        v.el.style.left = (cX + data.x * scale) + 'px';
        v.el.style.top = (cY + data.z * scale) + 'px';
        v.el.style.transform = `translate(-50%, -50%) rotate(${data.heading}deg)`;

        if (selectedId === data.id) updateStats();
        updateFleetList();
    });

    function selectVehicle(id) {
        if (selectedId && vehicles[selectedId]) vehicles[selectedId].el.classList.remove('selected');
        selectedId = id;
        vehicles[id].el.classList.add('selected');
        updateStats();
    }

    function updateStats() {
        const data = vehicles[selectedId].data;
        const delayColor = data.delay > 30 ? '#ff4444' : '#00ff00';
        const delayText = data.delay > 30 ? `+${Math.floor(data.delay/60)}m ${data.delay%60}s Késés` : "Menetrend szerint";

        document.getElementById('stats-panel').innerHTML = `
            <div class="data-row"><span class="label">Járatszám</span><span class="value" style="color:var(--gob-yellow)">Line ${data.line}</span></div>
            <div class="data-row"><span class="label">Járművezető</span><span class="value">${data.driver}</span></div>
            <div class="data-row"><span class="label">Sebesség</span><span class="value">${data.speed} km/h</span></div>
            <div class="data-row"><span class="label">Következő megálló</span><span class="value">${data.nextStop}</span></div>
            <div class="delay-box" style="background: ${delayColor}22; color: ${delayColor}">${delayText}</div>
        `;
    }

    function updateFleetList() {
        const list = document.getElementById('fleet-list');
        list.innerHTML = "";
        Object.keys(vehicles).forEach(id => {
            const d = vehicles[id].data;
            const item = document.createElement('div');
            item.className = 'fleet-item';
            item.innerHTML = `<b>[Line ${d.line}]</b> ${d.driver}`;
            item.onclick = () => selectVehicle(id);
            list.appendChild(item);
        });
    }
</script>

</body>
</html>
